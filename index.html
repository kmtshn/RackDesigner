<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çµ„Éº„Éê„Éº„É©„ÉÉ„ÇØÊê≠ËºâÂõ≥„Ç®„Éá„Ç£„Çø Pro v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: 20px;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* „É©„ÉÉ„ÇØ„Çø„Éñ */
        .rack-tabs {
            background: #34495e;
            display: flex;
            align-items: center;
            padding: 0 15px;
            min-height: 40px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        
        .rack-tab {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 8px 20px;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .rack-tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .rack-tab.active {
            background: white;
            color: #2c3e50;
        }
        
        .rack-tab-close {
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        .rack-tab-close:hover {
            opacity: 1;
            color: #e74c3c;
        }
        
        .add-rack-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        .add-rack-btn:hover {
            background: #229954;
        }
        
        .view-mode-toggle {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }
        
        .view-mode-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .view-mode-btn.active {
            background: rgba(255,255,255,0.4);
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .control-panel {
            width: 320px;
            background: #f8f9fa;
            padding: 15px;
            border-right: 2px solid #dee2e6;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        /* ‰øùÂ≠ò„É°„É¢„É™„Çª„ÇØ„Ç∑„Éß„É≥ */
        .memory-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .memory-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .memory-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .memory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .memory-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .memory-item-info {
            flex: 1;
        }
        
        .memory-item-name {
            font-weight: bold;
            font-size: 12px;
            color: #2c3e50;
        }
        
        .memory-item-details {
            font-size: 10px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .memory-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .memory-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }
        
        .memory-btn-load {
            background: #667eea;
            color: white;
        }
        
        .memory-btn-load:hover {
            background: #5a67d8;
        }
        
        .memory-btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .memory-btn-delete:hover {
            background: #c0392b;
        }
        
        .save-memory-btn {
            width: 100%;
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .save-memory-btn:hover {
            background: #229954;
        }
        
        /* Ë§áÊï∞„É©„ÉÉ„ÇØË°®Á§∫ - ÊîπÂñÑÁâà */
        .multi-rack-view {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            overflow: auto;
            display: none;
        }
        
        .multi-rack-view.active {
            display: block;
        }
        
        .multi-rack-container {
            display: flex;
            gap: 15px;
            padding: 20px;
            min-width: fit-content;
            justify-content: flex-start;
            align-items: flex-end;
        }
        
        .mini-rack-wrapper {
            flex-shrink: 0;
            transform: scale(0.7);
            transform-origin: bottom left;
            margin-right: -120px;
        }
        
        .rack-area {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            overflow: auto;
        }
        
        .rack-area.hidden {
            display: none;
        }
        
        .rack-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            position: relative;
            padding-bottom: 50px;
        }
        
        .rack-container {
            position: relative;
            background: #e0e0e0;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            margin-left: 50px;
        }
        
        .rack-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .rack-frame {
            position: relative;
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px solid #1a1a1a;
            border-radius: 6px;
            box-shadow: 
                inset 0 0 15px rgba(0,0,0,0.5),
                0 4px 15px rgba(0,0,0,0.3);
            padding: 8px 4px;
        }
        
        .rack-inner {
            background: #1a1a1a;
            border: 2px solid #0a0a0a;
            border-radius: 3px;
            position: relative;
            padding: 0;
        }
        
        .rack-posts {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px;
            background: linear-gradient(90deg, #4a4a4a 0%, #3a3a3a 50%, #4a4a4a 100%);
            border: 1px solid #2a2a2a;
            z-index: 2;
        }
        
        .rack-posts.left {
            left: 0;
            border-radius: 2px 0 0 2px;
        }
        
        .rack-posts.right {
            right: 0;
            border-radius: 0 2px 2px 0;
        }
        
        .mounting-holes {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .rack-units-container {
            width: 400px;
            position: relative;
            padding: 0 12px;
        }
        
        .rack-unit {
            height: 24px;
            position: relative;
            display: flex;
            align-items: center;
            border-top: 1px solid #2a2a2a;
        }
        
        .rack-unit:first-child {
            border-top: none;
        }
        
        .unit-space {
            flex: 1;
            height: 100%;
            background: #0f0f0f;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a4a4a;
            font-size: 9px;
            transition: all 0.3s ease;
        }
        
        .unit-space:hover:not(.occupied) {
            background: #1a1a1a;
            cursor: pointer;
        }
        
        .unit-space.drag-over {
            background: #2a3a4a !important;
            border: 2px dashed #667eea;
        }
        
        .unit-number {
            position: absolute;
            left: -45px;
            font-size: 9px;
            color: #333;
            font-weight: bold;
            background: #fff;
            padding: 1px 3px;
            border-radius: 2px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            min-width: 22px;
            text-align: center;
        }
        
        .power-column {
            display: flex;
            flex-direction: column;
            position: relative;
            width: 90px;
        }
        
        .power-input-item {
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        .power-input-container {
            display: flex;
            align-items: center;
            gap: 3px;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .power-input-container input {
            width: 45px;
            padding: 1px 2px;
            border: 1px solid #ced4da;
            border-radius: 2px;
            font-size: 10px;
            text-align: right;
        }
        
        .power-input-container span {
            font-size: 10px;
            color: #666;
        }
        
        .power-total-container {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            font-weight: bold;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        
        .equipment {
            position: absolute;
            left: 12px;
            right: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 1px solid #333;
            border-radius: 3px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: move;
            transition: all 0.3s ease;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            z-index: 10;
            user-select: none;
        }
        
        .equipment.no-color {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            border-color: #343a40 !important;
        }
        
        .equipment.dragging {
            opacity: 0.5;
            z-index: 100;
        }
        
        .equipment:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            z-index: 11;
        }
        
        .equipment::before,
        .equipment::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: #888;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
        }
        
        .equipment::before {
            left: 4px;
        }
        
        .equipment::after {
            right: 4px;
        }
        
        .equipment-info {
            text-align: center;
            padding: 2px;
            position: relative;
            z-index: 1;
            pointer-events: none;
        }
        
        .equipment-name {
            font-size: 10px;
            margin-bottom: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .equipment-size {
            font-size: 9px;
            opacity: 0.9;
        }
        
        .delete-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0px 4px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 9px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
        }
        
        .equipment:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn:hover {
            background: rgba(255,0,0,0.5);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            margin-top: 20px;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal-btn-primary {
            background: #667eea;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #5a67d8;
        }
        
        .modal-btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn-cancel:hover {
            background: #5a6268;
        }
        
        .custom-size-input {
            display: none;
            margin-top: 10px;
        }
        
        .custom-size-input.show {
            display: block;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #495057;
            font-size: 13px;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            margin-top: 8px;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .rack-info {
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .equipment-list {
            margin-top: 15px;
            padding: 12px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .equipment-list h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .equipment-list-item {
            padding: 6px;
            margin: 4px 0;
            background: #f8f9fa;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .equipment-list-power {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .settings-section {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        
        .settings-section h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .custom-types-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .custom-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 3px;
        }
        
        .custom-type-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        
        .remove-type-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .total-power-summary {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            text-align: center;
        }
        
        .total-power-summary h4 {
            color: #856404;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .total-power-value {
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ•Ô∏è „Çµ„Éº„Éê„Éº„É©„ÉÉ„ÇØÊê≠ËºâÂõ≥„Ç®„Éá„Ç£„Çø Pro v2</h1>
            <div class="header-buttons">
                <button class="header-btn" onclick="openMemoryModal()">üíæ „É°„É¢„É™ÁÆ°ÁêÜ</button>
                <button class="header-btn" onclick="openSettingsModal()">‚öôÔ∏è Ë®≠ÂÆö</button>
                <button class="header-btn" onclick="exportData()">üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                <button class="header-btn" onclick="document.getElementById('importFile').click()">üì• „Ç§„É≥„Éù„Éº„Éà</button>
                <button class="header-btn" onclick="exportToExcel()">üìä ExcelÂá∫Âäõ</button>
                <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
            </div>
        </div>
        
        <div class="rack-tabs">
            <div id="rackTabsContainer"></div>
            <button class="add-rack-btn" onclick="addNewRack()" id="addRackBtn">+ „É©„ÉÉ„ÇØËøΩÂä†</button>
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" onclick="setViewMode('single', this)">ÂÄãÂà•Ë°®Á§∫</button>
                <button class="view-mode-btn" onclick="setViewMode('all', this)">‰∏ÄË¶ßË°®Á§∫</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="control-panel">
                <!-- „É°„É¢„É™„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="memory-section">
                    <h4>üíæ ‰øùÂ≠ò„É°„É¢„É™</h4>
                    <div class="memory-list" id="memoryList"></div>
                    <button class="save-memory-btn" onclick="saveToMemory()">ÁèæÂú®„ÅÆÊßãÊàê„Çí‰øùÂ≠ò</button>
                </div>
                
                <div class="control-section">
                    <h3>ÁèæÂú®„ÅÆ„É©„ÉÉ„ÇØË®≠ÂÆö</h3>
                    <div class="form-group">
                        <label for="currentRackName">„É©„ÉÉ„ÇØÂêç</label>
                        <input type="text" id="currentRackName" placeholder="‰æã: „É°„Ç§„É≥„É©„ÉÉ„ÇØ" onchange="updateCurrentRackName()">
                    </div>
                    <div class="form-group">
                        <label for="rackHeight">„É©„ÉÉ„ÇØÈ´ò„Åï (U)</label>
                        <select id="rackHeight">
                            <option value="12">12U</option>
                            <option value="24">24U</option>
                            <option value="36">36U</option>
                            <option value="42" selected>42U</option>
                            <option value="48">48U</option>
                            <option value="custom">„Ç´„Çπ„Çø„É†</option>
                        </select>
                        <div class="custom-size-input" id="customRackHeightInput">
                            <input type="number" id="customRackHeight" min="1" max="100" placeholder="È´ò„Åï„ÇíÂÖ•Âäõ (U)">
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Ê©üÂô®ËøΩÂä†</h3>
                    <div class="form-group">
                        <label for="equipmentType">Ê©üÂô®„Çø„Ç§„Éó</label>
                        <select id="equipmentType">
                            <option value="nas">NAS</option>
                            <option value="sv">„Çµ„Éº„Éê„Éº</option>
                            <option value="ups">UPS</option>
                            <option value="switch">„Çπ„Ç§„ÉÉ„ÉÅ</option>
                            <option value="lcd">LCD„Ç≥„É≥„ÇΩ„Éº„É´</option>
                            <option value="router">„É´„Éº„Çø„Éº</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="equipmentSize">„Çµ„Ç§„Ç∫ (U)</label>
                        <select id="equipmentSize">
                            <option value="1">1U</option>
                            <option value="2">2U</option>
                            <option value="3">3U</option>
                            <option value="4">4U</option>
                            <option value="custom">„Ç´„Çπ„Çø„É†</option>
                        </select>
                        <div class="custom-size-input" id="customSizeInput">
                            <input type="number" id="customSize" min="1" max="48" placeholder="„Çµ„Ç§„Ç∫„ÇíÂÖ•Âäõ (U)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="equipmentName">Ê©üÂô®Âêç</label>
                        <input type="text" id="equipmentName" placeholder="‰æã: Web Server 01">
                    </div>
                    
                    <div class="form-group">
                        <label for="startUnit">ÈñãÂßã‰ΩçÁΩÆ (UÁï™Âè∑)</label>
                        <input type="number" id="startUnit" min="1" value="1">
                    </div>
                    
                    <button class="btn" onclick="addEquipment()">Ê©üÂô®„ÇíËøΩÂä†</button>
                </div>
                
                <button class="btn btn-danger" onclick="clearCurrentRack()">ÁèæÂú®„ÅÆ„É©„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢</button>
                
                <div class="equipment-list">
                    <h4>Êê≠ËºâÊ©üÂô®„É™„Çπ„Éà</h4>
                    <div id="equipmentListContent"></div>
                </div>
                
                <div class="total-power-summary">
                    <h4>ÂÖ®„É©„ÉÉ„ÇØÂêàË®àÊ∂àË≤ªÈõªÂäõ</h4>
                    <div class="total-power-value" id="totalSystemPower">0 W</div>
                </div>
            </div>
            
            <div id="rackAreasContainer"></div>
            
            <div class="multi-rack-view" id="multiRackView">
                <div class="multi-rack-container" id="multiRackContainer"></div>
            </div>
        </div>
    </div>
    
    <!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Ê©üÂô®„ÅÆÁ∑®ÈõÜ
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editName">Ê©üÂô®Âêç</label>
                    <input type="text" id="editName">
                </div>
                <div class="form-group">
                    <label for="editSize">„Çµ„Ç§„Ç∫ (U)</label>
                    <select id="editSize">
                        <option value="1">1U</option>
                        <option value="2">2U</option>
                        <option value="3">3U</option>
                        <option value="4">4U</option>
                        <option value="custom">„Ç´„Çπ„Çø„É†</option>
                    </select>
                    <div class="custom-size-input" id="editCustomSizeInput">
                        <input type="number" id="editCustomSize" min="1" max="48" placeholder="„Çµ„Ç§„Ç∫„ÇíÂÖ•Âäõ (U)">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editPower">Ê∂àË≤ªÈõªÂäõ (W)</label>
                    <input type="number" id="editPower" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn modal-btn-primary" onclick="saveEdit()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- „É°„É¢„É™ÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="memoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                ‰øùÂ≠ò„É°„É¢„É™ÁÆ°ÁêÜ
                <span class="modal-close" onclick="closeMemoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="memoryName">‰øùÂ≠òÂêç</label>
                    <input type="text" id="memoryName" placeholder="‰æã: Êú¨Áï™Áí∞Â¢ÉÊßãÊàê">
                </div>
                <button class="btn btn-success" onclick="confirmSaveToMemory()">ÁèæÂú®„ÅÆÊßãÊàê„Çí‰øùÂ≠ò</button>
                
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px;">‰øùÂ≠òÊ∏à„ÅøÊßãÊàê</h4>
                    <div id="memoryModalList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Ë®≠ÂÆö
                <span class="modal-close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Ë°®Á§∫Ë®≠ÂÆö</h4>
                    <div class="toggle-switch">
                        <label class="switch">
                            <input type="checkbox" id="colorCoding" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Ê©üÂô®„Çø„Ç§„Éó„Åî„Å®„Å´Ëâ≤ÂàÜ„Åë„ÇíË°å„ÅÜ</span>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>Ê©üÂô®„Çø„Ç§„ÉóÁÆ°ÁêÜ</h4>
                    <div class="form-group">
                        <label>Êñ∞„Åó„ÅÑÊ©üÂô®„Çø„Ç§„Éó„ÇíËøΩÂä†</label>
                        <input type="text" id="newTypeName" placeholder="Ê©üÂô®„Çø„Ç§„ÉóÂêç">
                        <div class="color-picker-group">
                            <input type="color" id="newTypeColor" value="#667eea">
                            <button class="btn btn-success" onclick="addCustomType()">ËøΩÂä†</button>
                        </div>
                    </div>
                    <div class="custom-types-list" id="customTypesList"></div>
                </div>
                
                <div class="settings-section">
                    <h4>Êó¢ÂÆöÊ©üÂô®„Çø„Ç§„Éó„ÅÆËâ≤Ë®≠ÂÆö</h4>
                    <div id="defaultTypeColors"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="saveSettings()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        const MAX_RACKS = 5;
        const MAX_MEMORY_SLOTS = 10;
        const UNIT_HEIGHT = 24;
        const MAX_RACK_HEIGHT_FOR_EXCEL = 48;  // ExcelÂá∫ÂäõÊôÇ„ÅÆÊúÄÂ§ß„É©„ÉÉ„ÇØÈ´ò„Åï
        
        let racks = [];
        let currentRackIndex = 0;
        let savedMemories = [];
        let draggedEquipment = null;
        let draggedFromRack = null;
        let editingEquipmentId = null;
        let editingRackIndex = null;
        let viewMode = 'single';
        
        let settings = {
            colorCoding: true,
            customTypes: [],
            typeColors: {
                nas: '#f093fb',
                sv: '#4facfe',
                ups: '#43e97b',
                switch: '#fa709a',
                lcd: '#30cfd0',
                router: '#a8edea'
            }
        };
        
        // „É©„ÉÉ„ÇØ„ÇØ„É©„Çπ
        class Rack {
            constructor(name = '', height = 42) {
                this.id = Date.now() + Math.random();
                this.name = name || `„É©„ÉÉ„ÇØ${racks.length + 1}`;
                this.height = height;
                this.equipment = [];
            }
        }
        
        // ÂàùÊúüÂåñ
        function init() {
            loadSettings();
            loadMemories();
            
            // ÂàùÊúü„É©„ÉÉ„ÇØ„Çí‰ΩúÊàê
            if (racks.length === 0) {
                racks.push(new Rack('„É°„Ç§„É≥„É©„ÉÉ„ÇØ', 42));
            }
            
            updateRackTabs();
            switchToRack(0);
            updateMemoryList();
            updateTotalSystemPower();
        }
        
        // Êñ∞„Åó„ÅÑ„É©„ÉÉ„ÇØ„ÇíËøΩÂä†
        function addNewRack() {
            if (racks.length >= MAX_RACKS) {
                alert(`ÊúÄÂ§ß${MAX_RACKS}„Å§„Åæ„Åß„ÅÆ„É©„ÉÉ„ÇØ„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô`);
                return;
            }
            
            const newRack = new Rack();
            racks.push(newRack);
            updateRackTabs();
            switchToRack(racks.length - 1);
        }
        
        // „É©„ÉÉ„ÇØ„ÇíÂâäÈô§
        function removeRack(index) {
            if (racks.length <= 1) {
                alert('ÊúÄÂæå„ÅÆ„É©„ÉÉ„ÇØ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }
            
            if (confirm(`„Äå${racks[index].name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                racks.splice(index, 1);
                if (currentRackIndex >= racks.length) {
                    currentRackIndex = racks.length - 1;
                }
                updateRackTabs();
                switchToRack(currentRackIndex);
            }
        }
        
        // „É©„ÉÉ„ÇØ„Çø„Éñ„ÇíÊõ¥Êñ∞
        function updateRackTabs() {
            const container = document.getElementById('rackTabsContainer');
            container.innerHTML = '';
            
            racks.forEach((rack, index) => {
                const tab = document.createElement('button');
                tab.className = `rack-tab ${index === currentRackIndex ? 'active' : ''}`;
                tab.innerHTML = `
                    <span onclick="switchToRack(${index})">${rack.name}</span>
                    ${racks.length > 1 ? `<span class="rack-tab-close" onclick="event.stopPropagation(); removeRack(${index})">√ó</span>` : ''}
                `;
                container.appendChild(tab);
            });
            
            // „É©„ÉÉ„ÇØËøΩÂä†„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
            document.getElementById('addRackBtn').style.display = 
                racks.length >= MAX_RACKS ? 'none' : 'block';
        }
        
        // „É©„ÉÉ„ÇØ„ÇíÂàá„ÇäÊõø„Åà
        function switchToRack(index) {
            currentRackIndex = index;
            const rack = racks[index];
            
            // UIÊõ¥Êñ∞
            document.getElementById('currentRackName').value = rack.name;
            
            if (rack.height <= 48 && [12, 24, 36, 42, 48].includes(rack.height)) {
                document.getElementById('rackHeight').value = rack.height;
                document.getElementById('customRackHeightInput').classList.remove('show');
            } else {
                document.getElementById('rackHeight').value = 'custom';
                document.getElementById('customRackHeight').value = rack.height;
                document.getElementById('customRackHeightInput').classList.add('show');
            }
            
            updateRackTabs();
            
            if (viewMode === 'single') {
                renderSingleRack();
            } else {
                renderAllRacks();
            }
            
            updateEquipmentList();
            updateTotalSystemPower();
        }
        
        // ÁèæÂú®„ÅÆ„É©„ÉÉ„ÇØÂêç„ÇíÊõ¥Êñ∞
        function updateCurrentRackName() {
            const newName = document.getElementById('currentRackName').value;
            if (newName) {
                racks[currentRackIndex].name = newName;
                updateRackTabs();
            }
        }
        
        // „Éì„É•„Éº„É¢„Éº„Éâ„ÇíË®≠ÂÆöÔºàIDÈáçË§á„ÇíÂÆåÂÖ®„Å´Ëß£Ê±∫Ôºâ
        function setViewMode(mode, btn) {
            viewMode = mode;
            
            // „Éà„Ç∞„É´„ÅÆË¶ã„ÅüÁõÆ
            document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            
            const rackAreas = document.getElementById('rackAreasContainer');
            const multiView = document.getElementById('multiRackView');
            const multiContainer = document.getElementById('multiRackContainer');
            
            if (mode === 'single') {
                // ‰∏ÄË¶ßÂÅ¥„ÇíÂÆåÂÖ®„Å´Á©∫„Å´„Åô„ÇãÔºàIDÈáçË§á„ÇíÈÅø„Åë„ÇãÔºâ
                multiContainer.innerHTML = '';
                multiView.classList.remove('active');
                
                rackAreas.style.display = 'block';
                renderSingleRack();
            } else {
                // ÂÄãÂà•ÂÅ¥„ÇíÂÆåÂÖ®„Å´Á©∫„Å´„Åô„ÇãÔºàIDÈáçË§á„ÇíÈÅø„Åë„ÇãÔºâ
                rackAreas.innerHTML = '';
                rackAreas.style.display = 'none';
                
                multiView.classList.add('active');
                renderAllRacks();
            }
        }
        
        // Âçò‰∏Ä„É©„ÉÉ„ÇØ„ÇíÊèèÁîª
        function renderSingleRack() {
            const container = document.getElementById('rackAreasContainer');
            container.innerHTML = '';
            
            const rackArea = createRackArea(racks[currentRackIndex], currentRackIndex, false);
            container.appendChild(rackArea);
        }
        
        // ÂÖ®„É©„ÉÉ„ÇØ„ÇíÊèèÁîª
        function renderAllRacks() {
            const container = document.getElementById('multiRackContainer');
            container.innerHTML = '';
            
            racks.forEach((rack, index) => {
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'mini-rack-wrapper';
                
                const rackElement = createRackElement(rack, index, true);
                wrapperDiv.appendChild(rackElement);
                container.appendChild(wrapperDiv);
            });
        }
        
        // „É©„ÉÉ„ÇØ„Ç®„É™„Ç¢„Çí‰ΩúÊàê
        function createRackArea(rack, rackIndex, isMini) {
            const rackArea = document.createElement('div');
            rackArea.className = 'rack-area';
            rackArea.dataset.rackIndex = rackIndex;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'rack-wrapper';
            
            const rackElement = createRackElement(rack, rackIndex, isMini);
            wrapper.appendChild(rackElement);
            
            if (!isMini) {
                const powerColumn = document.createElement('div');
                powerColumn.className = 'power-column';
                powerColumn.id = `powerColumn-${rackIndex}`;
                wrapper.appendChild(powerColumn);
            }
            
            rackArea.appendChild(wrapper);
            return rackArea;
        }
        
        // „É©„ÉÉ„ÇØË¶ÅÁ¥†„Çí‰ΩúÊàêÔºàIDÊé•È†≠Ëæû„ÇíËøΩÂä†Ôºâ
        function createRackElement(rack, rackIndex, isMini) {
            const container = document.createElement('div');
            container.className = 'rack-container';
            
            if (isMini) {
                const label = document.createElement('div');
                label.className = 'rack-label';
                label.textContent = rack.name;
                container.appendChild(label);
            }
            
            const info = document.createElement('div');
            info.className = 'rack-info';
            info.textContent = `19„Ç§„É≥„ÉÅ ${rack.height}U „É©„ÉÉ„ÇØ`;
            container.appendChild(info);
            
            const frame = document.createElement('div');
            frame.className = 'rack-frame';
            
            const inner = document.createElement('div');
            inner.className = 'rack-inner';
            
            // IDÊé•È†≠Ëæû„ÇíËøΩÂä†„Åó„Å¶IDÈáçË§á„ÇíÂÆåÂÖ®„Å´Èò≤„Åê
            const prefix = isMini ? 'mini' : 'single';
            inner.innerHTML = `
                <div class="rack-posts left"></div>
                <div class="rack-posts right"></div>
                <div class="mounting-holes"></div>
                <div class="rack-units-container" id="${prefix}-rack-${rackIndex}"></div>
            `;
            
            frame.appendChild(inner);
            container.appendChild(frame);
            
            const powerTotal = document.createElement('div');
            powerTotal.className = 'power-total-container';
            powerTotal.id = `${prefix}-powerTotal-${rackIndex}`;
            powerTotal.textContent = 'ÂêàË®à: 0 W';
            // „Éü„ÉãË°®Á§∫„Åß„ÅØÈõªÂäõ„Éê„ÉÉ„Ç∏„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
            if (isMini) {
                powerTotal.style.display = 'none';
            }
            container.appendChild(powerTotal);
            
            // „É©„ÉÉ„ÇØ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            setTimeout(() => {
                renderRack(rack, rackIndex, isMini);
            }, 0);
            
            return container;
        }
        
        // „É©„ÉÉ„ÇØ„ÇíÊèèÁîªÔºàIDÊé•È†≠ËæûÂØæÂøúÔºâ
        function renderRack(rack, rackIndex, isMini) {
            const prefix = isMini ? 'mini' : 'single';
            const rackElement = document.getElementById(`${prefix}-rack-${rackIndex}`);
            if (!rackElement) return;
            
            rackElement.innerHTML = '';
            
            const powerColumn = !isMini ? document.getElementById(`powerColumn-${rackIndex}`) : null;
            if (powerColumn) {
                powerColumn.innerHTML = '';
                powerColumn.style.paddingTop = '28px';
            }
            
            // „É¶„Éã„ÉÉ„Éà„Çí‰ΩúÊàê
            for (let i = rack.height; i >= 1; i--) {
                const unit = document.createElement('div');
                unit.className = 'rack-unit';
                unit.dataset.unit = i;
                unit.dataset.rackIndex = rackIndex;
                
                const unitNumber = document.createElement('span');
                unitNumber.className = 'unit-number';
                unitNumber.textContent = `${i}U`;
                unit.appendChild(unitNumber);
                
                const unitSpace = document.createElement('div');
                unitSpace.className = 'unit-space';
                unitSpace.dataset.unit = i;
                unitSpace.dataset.rackIndex = rackIndex;
                
                // ‰∏ÄË¶ßË°®Á§∫„Åß„ÇÇ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÇíÊúâÂäπ„Å´„Åô„Çã
                unitSpace.addEventListener('dragover', handleDragOver);
                unitSpace.addEventListener('drop', handleDrop);
                unitSpace.addEventListener('dragleave', handleDragLeave);
                
                const equipment = getEquipmentAtUnit(rack, i);
                if (!equipment) {
                    unitSpace.textContent = 'Á©∫„Åç';
                } else {
                    unitSpace.classList.add('occupied');
                }
                
                unit.appendChild(unitSpace);
                rackElement.appendChild(unit);
                
                if (powerColumn) {
                    const powerRow = document.createElement('div');
                    powerRow.className = 'power-input-item';
                    powerRow.dataset.unit = i;
                    powerColumn.appendChild(powerRow);
                }
            }
            
            renderEquipments(rack, rackIndex, isMini);
            renderMountingHoles(rack, rackIndex, isMini);
        }
        
        // „Éû„Ç¶„É≥„Éà„Éõ„Éº„É´„ÇíÊèèÁîªÔºàIDÊé•È†≠ËæûÂØæÂøúÔºâ
        function renderMountingHoles(rack, rackIndex, isMini) {
            const prefix = isMini ? 'mini' : 'single';
            const rackElement = document.getElementById(`${prefix}-rack-${rackIndex}`);
            if (!rackElement) return;
            
            const mountingHoles = rackElement.parentElement.querySelector('.mounting-holes');
            if (!mountingHoles) return;
            
            mountingHoles.innerHTML = '';
            
            for (let i = 0; i < rack.height; i++) {
                const holeSet = document.createElement('div');
                holeSet.style.position = 'absolute';
                holeSet.style.top = `${i * UNIT_HEIGHT + 8}px`;
                holeSet.style.width = '100%';
                holeSet.style.height = `${UNIT_HEIGHT}px`;
                
                for (let j = 0; j < 2; j++) {
                    ['5px', null].forEach(side => {
                        const hole = document.createElement('div');
                        hole.style.position = 'absolute';
                        hole.style[side ? 'left' : 'right'] = '5px';
                        hole.style.top = `${6 + j * 8}px`;
                        hole.style.width = '2px';
                        hole.style.height = '5px';
                        hole.style.background = '#000';
                        hole.style.borderRadius = '1px';
                        holeSet.appendChild(hole);
                    });
                }
                
                mountingHoles.appendChild(holeSet);
            }
        }
        
        // Ê©üÂô®„ÇíÊèèÁîªÔºàIDÊé•È†≠ËæûÂØæÂøúÔºâ
        function renderEquipments(rack, rackIndex, isMini) {
            const prefix = isMini ? 'mini' : 'single';
            const rackElement = document.getElementById(`${prefix}-rack-${rackIndex}`);
            const powerColumn = !isMini ? document.getElementById(`powerColumn-${rackIndex}`) : null;
            
            if (powerColumn) {
                powerColumn.querySelectorAll('.power-input-container').forEach(el => el.remove());
            }
            
            rack.equipment.forEach(equipment => {
                const startUnit = equipment.startUnit;
                const endUnit = startUnit + equipment.size - 1;
                
                const topPosition = (rack.height - endUnit) * UNIT_HEIGHT;
                const height = equipment.size * UNIT_HEIGHT - 1;
                
                const equipmentDiv = document.createElement('div');
                equipmentDiv.className = `equipment type-${equipment.type}`;
                if (!settings.colorCoding) {
                    equipmentDiv.classList.add('no-color');
                } else if (settings.typeColors[equipment.type]) {
                    const color = settings.typeColors[equipment.type];
                    equipmentDiv.style.background = `linear-gradient(135deg, ${color} 0%, ${color}dd 100%)`;
                }
                
                equipmentDiv.style.top = `${topPosition}px`;
                equipmentDiv.style.height = `${height}px`;
                equipmentDiv.dataset.id = equipment.id;
                equipmentDiv.dataset.rackIndex = rackIndex;
                
                // ‰∏ÄË¶ßË°®Á§∫„Åß„ÇÇ„Éâ„É©„ÉÉ„Ç∞„ÇíÊúâÂäπ„Å´„Åô„Çã
                equipmentDiv.draggable = true;
                equipmentDiv.addEventListener('dragstart', handleDragStart);
                equipmentDiv.addEventListener('dragend', handleDragEnd);
                
                if (!isMini) {
                    equipmentDiv.addEventListener('dblclick', () => openEditModal(equipment.id, rackIndex));
                }
                
                equipmentDiv.innerHTML = `
                    <div class="equipment-info">
                        <div class="equipment-name">${equipment.name}</div>
                        <div class="equipment-size">${equipment.size}U</div>
                    </div>
                    ${!isMini ? `<button class="delete-btn" onclick="deleteEquipment(${equipment.id}, ${rackIndex})">ÂâäÈô§</button>` : ''}
                `;
                
                rackElement.appendChild(equipmentDiv);
                
                // „É¶„Éã„ÉÉ„Éà„Çπ„Éö„Éº„Çπ„ÇíÂç†ÊúâÁä∂ÊÖã„Å´
                for (let i = startUnit; i <= endUnit; i++) {
                    const unitSpace = rackElement.querySelector(`.unit-space[data-unit="${i}"]`);
                    if (unitSpace) {
                        unitSpace.classList.add('occupied');
                        unitSpace.textContent = '';
                    }
                }
                
                // ÈõªÂäõÂÖ•Âäõ„ÇíËøΩÂä†
                if (powerColumn) {
                    const middleUnit = Math.floor((startUnit + endUnit) / 2);
                    const powerRow = powerColumn.querySelector(`.power-input-item[data-unit="${middleUnit}"]`);
                    
                    if (powerRow) {
                        const powerInputContainer = document.createElement('div');
                        powerInputContainer.className = 'power-input-container';
                        powerInputContainer.innerHTML = `
                            <input type="number" 
                                   value="${equipment.power || 0}" 
                                   onchange="updatePower(${equipment.id}, ${rackIndex}, this.value)"
                                   placeholder="0">
                            <span>W</span>
                        `;
                        powerRow.appendChild(powerInputContainer);
                    }
                }
            });
            
            updateRackPower(rackIndex, isMini);
        }
        
        // Ê©üÂô®„ÇíËøΩÂä†
        function addEquipment() {
            const rack = racks[currentRackIndex];
            const type = document.getElementById('equipmentType').value;
            let size = document.getElementById('equipmentSize').value;
            
            if (size === 'custom') {
                size = parseInt(document.getElementById('customSize').value);
                if (!size || size < 1) {
                    alert('„Ç´„Çπ„Çø„É†„Çµ„Ç§„Ç∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
            } else {
                size = parseInt(size);
            }
            
            const name = document.getElementById('equipmentName').value || getDefaultName(type);
            const startUnit = parseInt(document.getElementById('startUnit').value);
            
            if ((type === 'lcd' || type === 'router') && size > 1) {
                alert('LCD„Ç≥„É≥„ÇΩ„Éº„É´„Å®„É´„Éº„Çø„Éº„ÅØ1U„Çµ„Ç§„Ç∫„ÅÆ„Åø„Åß„Åô');
                return;
            }
            
            if (startUnit < 1 || startUnit + size - 1 > rack.height) {
                alert('ÊåáÂÆö„Åó„Åü‰ΩçÁΩÆ„Å´Ê©üÂô®„ÇíÈÖçÁΩÆ„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }
            
            for (let i = startUnit; i < startUnit + size; i++) {
                if (getEquipmentAtUnit(rack, i)) {
                    alert('ÊåáÂÆö„Åó„Åü‰ΩçÁΩÆ„Å´Êó¢„Å´Ê©üÂô®„ÅåÂ≠òÂú®„Åó„Åæ„Åô');
                    return;
                }
            }
            
            rack.equipment.push({
                id: Date.now(),
                type: type,
                size: size,
                name: name,
                startUnit: startUnit,
                power: 0
            });
            
            if (viewMode === 'single') {
                renderSingleRack();
            } else {
                renderAllRacks();
            }
            updateEquipmentList();
            updateTotalSystemPower();
        }
        
// ExcelÂá∫ÂäõÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ
async function exportToExcel() {
    try {
        if (typeof ExcelJS === 'undefined') {
            alert('ExcelÂá∫Âäõ„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }

        const workbook = new ExcelJS.Workbook();
        
        // ÂêÑ„É©„ÉÉ„ÇØ„Åî„Å®„Å´„Ç∑„Éº„Éà„Çí‰ΩúÊàê
        racks.forEach((rack, rackIndex) => {
            const worksheet = workbook.addWorksheet(rack.name);
            
            // „Çø„Ç§„Éà„É´Ë°å
            worksheet.mergeCells('A1:I1');
            const titleCell = worksheet.getCell('A1');
            titleCell.value = `${rack.name} - 19„Ç§„É≥„ÉÅ ${rack.height}U „Çµ„Éº„Éê„Éº„É©„ÉÉ„ÇØÊê≠ËºâÂõ≥`;
            titleCell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 14 };
            titleCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF2C3E50' }
            };
            titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
            titleCell.border = {
                top: {style:'medium'},
                left: {style:'medium'},
                bottom: {style:'medium'},
                right: {style:'medium'}
            };
            
            // Á©∫Ë°å
            worksheet.addRow([]);
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å
            const headerRow = worksheet.addRow(['UÁï™Âè∑', '', '„É©„ÉÉ„ÇØÂÜÖÈÉ®', '', '', '', 'Ê∂àË≤ªÈõªÂäõ(W)', 'Ê©üÂô®„Çø„Ç§„Éó', 'Ê©üÂô®Âêç']);
            worksheet.mergeCells(3, 3, 3, 5);
            
            // „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çπ„Çø„Ç§„É´Ë®≠ÂÆö
            for (let col = 1; col <= 9; col++) {
                const cell = worksheet.getCell(3, col);
                
                if (col === 1) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE0E0E0' }
                    };
                    cell.font = { bold: true, size: 10 };
                } else if (col === 2 || col === 6) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF4A4A4A' }
                    };
                } else if (col === 3) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF1A1A1A' }
                    };
                    cell.font = { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 };
                } else if (col === 7) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFF3CD' }
                    };
                    cell.font = { bold: true, size: 10 };
                } else if (col === 8) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE3F2FD' }
                    };
                    cell.font = { bold: true, size: 10 };
                } else if (col === 9) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F5E9' }
                    };
                    cell.font = { bold: true, size: 10 };
                }
                
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: {style:'medium'},
                    left: {style:'thin'},
                    bottom: {style:'medium'},
                    right: {style:'thin'}
                };
            }
            
            // Á©∫Ë°å„ÅÆÊï∞„ÇíË®àÁÆóÔºàÂ∫ïËæ∫„ÇíÊèÉ„Åà„Çã„Åü„ÇÅÔºâ
            const emptyRowsCount = MAX_RACK_HEIGHT_FOR_EXCEL - rack.height;
            
            // ‰∏äÈÉ®„ÅÆÁ©∫Ë°å„ÇíËøΩÂä†
            for (let i = 0; i < emptyRowsCount; i++) {
                const emptyRow = worksheet.addRow(['', '', '', '', '', '', '', '', '']);
                const rowNumber = worksheet.rowCount;
                
                // Á©∫Ë°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
                worksheet.mergeCells(rowNumber, 3, rowNumber, 5);
                for (let col = 1; col <= 9; col++) {
                    const cell = worksheet.getCell(rowNumber, col);
                    if (col === 2 || col === 6) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF3A3A3A' }
                        };
                    } else if (col === 3) {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE0E0E0' }
                        };
                    }
                }
            }
            
            // ÂêÑU‰ΩçÁΩÆ„ÅÆÂç†ÊúâÁä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„ÇãÈÖçÂàó
            const unitOccupancy = new Array(rack.height + 1).fill(null);
            
            // Ê©üÂô®„ÅÆÂç†ÊúâÁä∂ÊÖã„Çí„Éû„Éº„ÇØ
            rack.equipment.forEach(eq => {
                for (let u = eq.startUnit; u < eq.startUnit + eq.size; u++) {
                    unitOccupancy[u] = eq;
                }
            });
            
            // ÂêÑU„Åî„Å®„ÅÆË°å„ÇíÁîüÊàêÔºà‰∏ä„Åã„Çâ‰∏ã„Å∏Ôºâ- ‰øÆÊ≠£Áâà
            let u = rack.height;
            while (u >= 1) {
                const equipment = unitOccupancy[u];
                
                // Ê©üÂô®„ÅÆÊúÄ‰∏äÈÉ®„ÅÆUnit„ÅÆÂ†¥Âêà
                if (equipment && u === equipment.startUnit + equipment.size - 1) {
                    const startRow = worksheet.rowCount + 1;
                    
                    // Ê©üÂô®„ÅÆ„Çµ„Ç§„Ç∫ÂàÜ„ÅÆË°å„ÇíÂÖà„Å´‰ΩúÊàê
                    for (let i = 0; i < equipment.size; i++) {
                        const currentU = u - i;
                        worksheet.addRow([`${currentU}U`, '', '', '', '', '', '', '', '']);
                    }
                    
                    const endRow = startRow + equipment.size - 1;
                    
                    // „Çª„É´„ÅÆÁµêÂêà
                    worksheet.mergeCells(startRow, 3, endRow, 5); // „É©„ÉÉ„ÇØÂÜÖÈÉ®
                    worksheet.mergeCells(startRow, 7, endRow, 7); // Ê∂àË≤ªÈõªÂäõ
                    worksheet.mergeCells(startRow, 8, endRow, 8); // Ê©üÂô®„Çø„Ç§„Éó
                    worksheet.mergeCells(startRow, 9, endRow, 9); // Ê©üÂô®Âêç
                    
                    // ÂêÑË°å„ÅÆUÁï™Âè∑„Å®„Éï„É¨„Éº„É†„ÅÆ„Çπ„Çø„Ç§„É´Ë®≠ÂÆö
                    for (let rowIdx = startRow; rowIdx <= endRow; rowIdx++) {
                        // UÁï™Âè∑„ÅÆ„Çπ„Çø„Ç§„É´
                        const uCell = worksheet.getCell(rowIdx, 1);
                        uCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF0F0F0' }
                        };
                        uCell.font = { bold: true, size: 9 };
                        uCell.alignment = { horizontal: 'center', vertical: 'middle' };
                        uCell.border = {
                            top: {style:'thin'},
                            left: {style:'medium'},
                            bottom: {style:'thin'},
                            right: {style:'thin'}
                        };
                        
                        // „Éï„É¨„Éº„É†Âàó„ÅÆ„Çπ„Çø„Ç§„É´
                        [2, 6].forEach(col => {
                            const frameCell = worksheet.getCell(rowIdx, col);
                            frameCell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF3A3A3A' }
                            };
                            frameCell.border = {
                                top: {style:'thin'},
                                left: {style:'thin'},
                                bottom: {style:'thin'},
                                right: {style:'thin'}
                            };
                        });
                    }
                    
                    // Ê©üÂô®„Éá„Éº„Çø„ÇíË®≠ÂÆö
                    const equipmentCell = worksheet.getCell(startRow, 3);
                    equipmentCell.value = `${equipment.name} (${equipment.size}U)`;
                    
                    // Ê©üÂô®„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüËâ≤„ÇíË®≠ÂÆö
                    const color = getEquipmentColorARGB(equipment.type);
                    equipmentCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: color }
                    };
                    equipmentCell.font = { 
                        bold: true, 
                        color: { argb: 'FFFFFFFF' },
                        size: 10
                    };
                    equipmentCell.alignment = { 
                        horizontal: 'center', 
                        vertical: 'middle',
                        wrapText: true 
                    };
                    equipmentCell.border = {
                        top: {style:'medium'},
                        left: {style:'medium'},
                        bottom: {style:'medium'},
                        right: {style:'medium'}
                    };
                    
                    // Ê∂àË≤ªÈõªÂäõ
                    const powerCell = worksheet.getCell(startRow, 7);
                    powerCell.value = equipment.power || 0;
                    powerCell.font = { 
                        bold: true,
                        color: { argb: 'FFE74C3C' }
                    };
                    powerCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    powerCell.border = {
                        top: {style:'medium'},
                        left: {style:'thin'},
                        bottom: {style:'medium'},
                        right: {style:'thin'}
                    };
                    
                    // Ê©üÂô®„Çø„Ç§„Éó
                    const typeCell = worksheet.getCell(startRow, 8);
                    typeCell.value = getTypeDisplayName(equipment.type);
                    typeCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    typeCell.border = {
                        top: {style:'medium'},
                        left: {style:'thin'},
                        bottom: {style:'medium'},
                        right: {style:'thin'}
                    };
                    
                    // Ê©üÂô®Âêç
                    const nameCell = worksheet.getCell(startRow, 9);
                    nameCell.value = equipment.name;
                    nameCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    nameCell.border = {
                        top: {style:'medium'},
                        left: {style:'thin'},
                        bottom: {style:'medium'},
                        right: {style:'thin'}
                    };
                    
                    // Ê©üÂô®„ÅÆ„Çµ„Ç§„Ç∫ÂàÜ„Å†„ÅëU„Çí„Çπ„Ç≠„ÉÉ„Éó
                    u -= equipment.size;
                    
                } else if (!equipment) {
                    // Á©∫„Åç„Çπ„É≠„ÉÉ„Éà
                    const row = worksheet.addRow([`${u}U`, '', '', '', '', '', '-', '-', '-']);
                    const rowNumber = row.number;
                    
                    // UÁï™Âè∑„ÅÆ„Çπ„Çø„Ç§„É´
                    const uCell = worksheet.getCell(rowNumber, 1);
                    uCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF0F0F0' }
                    };
                    uCell.font = { bold: true, size: 9 };
                    uCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    uCell.border = {
                        top: {style:'thin'},
                        left: {style:'medium'},
                        bottom: {style:'thin'},
                        right: {style:'thin'}
                    };
                    
                    // „Éï„É¨„Éº„É†Âàó„ÅÆ„Çπ„Çø„Ç§„É´
                    [2, 6].forEach(col => {
                        const frameCell = worksheet.getCell(rowNumber, col);
                        frameCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF3A3A3A' }
                        };
                        frameCell.border = {
                            top: {style:'thin'},
                            left: {style:'thin'},
                            bottom: {style:'thin'},
                            right: {style:'thin'}
                        };
                    });
                    
                    // Á©∫„Åç„Çπ„É≠„ÉÉ„ÉàÔºà3-5Âàó„ÇíÁµêÂêàÔºâ
                    worksheet.mergeCells(rowNumber, 3, rowNumber, 5);
                    const emptyCell = worksheet.getCell(rowNumber, 3);
                    emptyCell.value = '„Äê Á©∫„Åç „Äë';
                    emptyCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF0F0F0F' }
                    };
                    emptyCell.font = { 
                        color: { argb: 'FF666666' },
                        size: 9
                    };
                    emptyCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    emptyCell.border = {
                        top: {style:'thin', color: {argb: 'FF2A2A2A'}},
                        left: {style:'thin'},
                        bottom: {style:'thin', color: {argb: 'FF2A2A2A'}},
                        right: {style:'thin'}
                    };
                    
                    // ‰ªñ„ÅÆÂàó„ÅÆ„Çπ„Çø„Ç§„É´
                    for (let col = 7; col <= 9; col++) {
                        const cell = worksheet.getCell(rowNumber, col);
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: {style:'thin'},
                            left: {style:'thin'},
                            bottom: {style:'thin'},
                            right: {style:'thin'}
                        };
                    }
                    
                    u--;
                } else {
                    // Ê©üÂô®„ÅÆ‰∏≠ÈñìÈÉ®ÂàÜ„Å™„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó
                    u--;
                }
            }
            
            // ‰∏ãÈÉ®„Éï„É¨„Éº„É†
            const bottomFrameRow = worksheet.addRow(['', '', '', '', '', '', '', '', '']);
            const bottomRowNumber = worksheet.rowCount;
            worksheet.mergeCells(bottomRowNumber, 1, bottomRowNumber, 6);
            const bottomCell = worksheet.getCell(bottomRowNumber, 1);
            bottomCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF2A2A2A' }
            };
            bottomCell.border = {
                top: {style:'medium'},
                left: {style:'medium'},
                bottom: {style:'medium'},
                right: {style:'medium'}
            };
            
            // Á©∫Ë°å
            worksheet.addRow([]);
            
            // ÂêàË®àË°å
            const totalPower = rack.equipment.reduce((sum, eq) => sum + (eq.power || 0), 0);
            const totalRow = worksheet.addRow(['', 'ÂêàË®àÊ∂àË≤ªÈõªÂäõ', '', '', '', '', totalPower, 'W', '']);
            const totalRowNumber = worksheet.rowCount;
            
            worksheet.mergeCells(totalRowNumber, 2, totalRowNumber, 6);
            
            const totalLabelCell = worksheet.getCell(totalRowNumber, 2);
            totalLabelCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFFFEB3B' }
            };
            totalLabelCell.font = { bold: true, color: { argb: 'FF000000' }, size: 12 };
            totalLabelCell.alignment = { horizontal: 'center', vertical: 'middle' };
            totalLabelCell.border = {
                top: {style:'medium'},
                left: {style:'medium'},
                bottom: {style:'medium'},
                right: {style:'medium'}
            };
            
            const totalValueCell = worksheet.getCell(totalRowNumber, 7);
            totalValueCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFFFEB3B' }
            };
            totalValueCell.font = { bold: true, color: { argb: 'FFE74C3C' }, size: 14 };
            totalValueCell.alignment = { horizontal: 'center', vertical: 'middle' };
            totalValueCell.border = {
                top: {style:'medium'},
                left: {style:'medium'},
                bottom: {style:'medium'},
                right: {style:'medium'}
            };
            
            const totalUnitCell = worksheet.getCell(totalRowNumber, 8);
            totalUnitCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFFFEB3B' }
            };
            totalUnitCell.font = { bold: true, color: { argb: 'FFE74C3C' }, size: 12 };
            totalUnitCell.alignment = { horizontal: 'center', vertical: 'middle' };
            totalUnitCell.border = {
                top: {style:'medium'},
                left: {style:'medium'},
                bottom: {style:'medium'},
                right: {style:'medium'}
            };
            
            // ÂàóÂπÖ„ÅÆË®≠ÂÆö
            worksheet.columns = [
                { width: 8 },   // UÁï™Âè∑
                { width: 2 },   // „Éï„É¨„Éº„É†Â∑¶
                { width: 15 },  // „É©„ÉÉ„ÇØÂÜÖÈÉ®1
                { width: 15 },  // „É©„ÉÉ„ÇØÂÜÖÈÉ®2
                { width: 15 },  // „É©„ÉÉ„ÇØÂÜÖÈÉ®3
                { width: 2 },   // „Éï„É¨„Éº„É†Âè≥
                { width: 12 },  // Ê∂àË≤ªÈõªÂäõ
                { width: 15 },  // Ê©üÂô®„Çø„Ç§„Éó
                { width: 25 }   // Ê©üÂô®Âêç
            ];
            
            // Ë°å„ÅÆÈ´ò„ÅïË®≠ÂÆö
            worksheet.getRow(1).height = 30;
            worksheet.getRow(3).height = 25;
            // ÂÖ®„Éá„Éº„ÇøË°å„ÅÆÈ´ò„Åï„ÇíÁµ±‰∏Ä
            for (let i = 4; i <= worksheet.rowCount - 2; i++) {
                const row = worksheet.getRow(i);
                if (row) {
                    row.height = 20;
                }
            }
        });
        
        // „Çµ„Éû„É™„Éº„Ç∑„Éº„Éà„ÇíËøΩÂä†
        const summarySheet = workbook.addWorksheet('„Çµ„Éû„É™„Éº', { position: 0 });
        
        // „Çø„Ç§„Éà„É´
        summarySheet.mergeCells('A1:E1');
        const summaryTitle = summarySheet.getCell('A1');
        summaryTitle.value = '„Çµ„Éº„Éê„Éº„É©„ÉÉ„ÇØÊê≠ËºâÂõ≥ „Çµ„Éû„É™„Éº';
        summaryTitle.font = { bold: true, size: 16, color: { argb: 'FF2C3E50' } };
        summaryTitle.alignment = { horizontal: 'center', vertical: 'middle' };
        summaryTitle.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE8F5E9' }
        };
        
        summarySheet.addRow([]);
        summarySheet.addRow(['‰ΩúÊàêÊó•ÊôÇ:', new Date().toLocaleString('ja-JP')]);
        summarySheet.addRow([]);
        
        // „Éò„ÉÉ„ÉÄ„Éº
        const summaryHeader = summarySheet.addRow(['No.', '„É©„ÉÉ„ÇØÂêç', 'È´ò„Åï(U)', 'Êê≠ËºâÊ©üÂô®Êï∞', 'Ê∂àË≤ªÈõªÂäõ(W)']);
        summaryHeader.font = { bold: true };
        summaryHeader.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF4A90E2' }
        };
        summaryHeader.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        
        let totalSystemPower = 0;
        let totalEquipmentCount = 0;
        
        // ÂêÑ„É©„ÉÉ„ÇØ„ÅÆÊÉÖÂ†±
        racks.forEach((rack, index) => {
            const power = rack.equipment.reduce((sum, eq) => sum + (eq.power || 0), 0);
            totalSystemPower += power;
            totalEquipmentCount += rack.equipment.length;
            
            const row = summarySheet.addRow([
                index + 1,
                rack.name,
                rack.height,
                rack.equipment.length,
                power
            ]);
            
            // ‰∫§‰∫í„Å´ËÉåÊôØËâ≤„ÇíË®≠ÂÆö
            if (index % 2 === 0) {
                row.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF5F5F5' }
                };
            }
        });
        
        summarySheet.addRow([]);
        
        // ÂêàË®àË°å
        const totalRow = summarySheet.addRow(['', 'ÂêàË®à', '', totalEquipmentCount, totalSystemPower]);
        totalRow.font = { bold: true, size: 12 };
        totalRow.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFEB3B' }
        };
        
        // ÂàóÂπÖË®≠ÂÆö
        summarySheet.columns = [
            { width: 8 },   // No.
            { width: 25 },  // „É©„ÉÉ„ÇØÂêç
            { width: 12 },  // È´ò„Åï
            { width: 15 },  // Êê≠ËºâÊ©üÂô®Êï∞
            { width: 15 }   // Ê∂àË≤ªÈõªÂäõ
        ];
        
        // Êû†Á∑ö„ÇíËøΩÂä†
        const lastRow = summarySheet.lastRow.number;
        for (let row = 1; row <= lastRow; row++) {
            for (let col = 1; col <= 5; col++) {
                const cell = summarySheet.getCell(row, col);
                if (row === 1 || row === 5 || row === lastRow) {
                    cell.border = {
                        top: {style:'medium'},
                        left: {style:'medium'},
                        bottom: {style:'medium'},
                        right: {style:'medium'}
                    };
                } else if (row > 5 && row < lastRow) {
                    cell.border = {
                        top: {style:'thin'},
                        left: {style:'thin'},
                        bottom: {style:'thin'},
                        right: {style:'thin'}
                    };
                }
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
            }
        }
        
        // Excel„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `rack_diagram_${new Date().getTime()}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        console.log('ExcelÂá∫ÂäõÂÆå‰∫Ü');
        
    } catch (error) {
        console.error('ExcelÂá∫Âäõ„Ç®„É©„Éº:', error);
        alert('ExcelÂá∫Âäõ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n' + error.message);
    }
}

        
        // Ê©üÂô®„Çø„Ç§„Éó„ÅÆËâ≤„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞ÔºàARGBÂΩ¢ÂºèÔºâ
        function getEquipmentColorARGB(type) {
            const defaultColors = {
                nas: 'FFF093FB',
                sv: 'FF4FACFE',
                ups: 'FF43E97B',
                switch: 'FFFA709A',
                lcd: 'FF30CFD0',
                router: 'FFA8EDEA'
            };
            
            // „Ç´„Çπ„Çø„É†„Çø„Ç§„Éó„ÅÆËâ≤„ÇíÂèñÂæó
            if (settings.typeColors[type]) {
                const hex = settings.typeColors[type].replace('#', '');
                return 'FF' + hex.toUpperCase();
            }
            
            return defaultColors[type] || 'FF667EEA';
        }
        
        // „Çø„Ç§„Éó„ÅÆË°®Á§∫Âêç„ÇíÂèñÂæó
        function getTypeDisplayName(type) {
            const customType = settings.customTypes.find(t => t.id === type);
            if (customType) return customType.name;
            
            const typeNames = {
                nas: 'NAS',
                sv: '„Çµ„Éº„Éê„Éº',
                ups: 'UPS',
                switch: '„Çπ„Ç§„ÉÉ„ÉÅ',
                lcd: 'LCD„Ç≥„É≥„ÇΩ„Éº„É´',
                router: '„É´„Éº„Çø„Éº'
            };
            return typeNames[type] || type;
        }
        
        // „É°„É¢„É™„Å´‰øùÂ≠ò
        function saveToMemory() {
            document.getElementById('memoryName').value = '';
            openMemoryModal();
        }
        
        function confirmSaveToMemory() {
            const name = document.getElementById('memoryName').value;
            if (!name) {
                alert('‰øùÂ≠òÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (savedMemories.length >= MAX_MEMORY_SLOTS) {
                alert(`ÊúÄÂ§ß${MAX_MEMORY_SLOTS}ÂÄã„Åæ„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åô`);
                return;
            }
            
            const memory = {
                id: Date.now(),
                name: name,
                date: new Date().toLocaleString('ja-JP'),
                racks: JSON.parse(JSON.stringify(racks)),
                settings: JSON.parse(JSON.stringify(settings))
            };
            
            savedMemories.push(memory);
            saveMemoriesToStorage();
            updateMemoryList();
            updateMemoryModalList();
            closeMemoryModal();
            alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }
        
        // „É°„É¢„É™„Åã„ÇâË™≠„ÅøËæº„Åø
        function loadFromMemory(memoryId) {
            const memory = savedMemories.find(m => m.id === memoryId);
            if (!memory) return;
            
            if (confirm(`„Äå${memory.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆÊßãÊàê„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ`)) {
                racks = JSON.parse(JSON.stringify(memory.racks));
                settings = JSON.parse(JSON.stringify(memory.settings));
                currentRackIndex = 0;
                
                saveSettings();
                updateRackTabs();
                switchToRack(0);
                alert('Ë™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
            }
        }
        
        // „É°„É¢„É™„ÇíÂâäÈô§
        function deleteMemory(memoryId) {
            const memory = savedMemories.find(m => m.id === memoryId);
            if (!memory) return;
            
            if (confirm(`„Äå${memory.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                savedMemories = savedMemories.filter(m => m.id !== memoryId);
                saveMemoriesToStorage();
                updateMemoryList();
                updateMemoryModalList();
            }
        }
        
        // „É°„É¢„É™„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateMemoryList() {
            const list = document.getElementById('memoryList');
            
            if (savedMemories.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            list.innerHTML = savedMemories.map(memory => {
                const totalEquipment = memory.racks.reduce((sum, rack) => sum + rack.equipment.length, 0);
                return `
                    <div class="memory-item">
                        <div class="memory-item-info">
                            <div class="memory-item-name">${memory.name}</div>
                            <div class="memory-item-details">
                                ${memory.date} | ${memory.racks.length}„É©„ÉÉ„ÇØ | ${totalEquipment}Ê©üÂô®
                            </div>
                        </div>
                        <div class="memory-item-actions">
                            <button class="memory-btn memory-btn-load" onclick="loadFromMemory(${memory.id})">Ë™≠Ëæº</button>
                            <button class="memory-btn memory-btn-delete" onclick="deleteMemory(${memory.id})">ÂâäÈô§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // „É°„É¢„É™„É¢„Éº„ÉÄ„É´„ÅÆ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateMemoryModalList() {
            const list = document.getElementById('memoryModalList');
            
            if (savedMemories.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; padding: 20px;">‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            list.innerHTML = savedMemories.map(memory => {
                const totalEquipment = memory.racks.reduce((sum, rack) => sum + rack.equipment.length, 0);
                return `
                    <div class="memory-item">
                        <div class="memory-item-info">
                            <div class="memory-item-name">${memory.name}</div>
                            <div class="memory-item-details">
                                ${memory.date} | ${memory.racks.length}„É©„ÉÉ„ÇØ | ${totalEquipment}Ê©üÂô®
                            </div>
                        </div>
                        <div class="memory-item-actions">
                            <button class="memory-btn memory-btn-load" onclick="loadFromMemory(${memory.id}); closeMemoryModal();">Ë™≠Ëæº</button>
                            <button class="memory-btn memory-btn-delete" onclick="deleteMemory(${memory.id})">ÂâäÈô§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // „Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
        function saveMemoriesToStorage() {
            localStorage.setItem('rackMemories', JSON.stringify(savedMemories));
        }
        
        // „Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
        function loadMemories() {
            const saved = localStorage.getItem('rackMemories');
            if (saved) {
                savedMemories = JSON.parse(saved);
            }
        }
        
        // „É°„É¢„É™„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openMemoryModal() {
            updateMemoryModalList();
            document.getElementById('memoryModal').style.display = 'block';
        }
        
        // „É°„É¢„É™„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeMemoryModal() {
            document.getElementById('memoryModal').style.display = 'none';
        }
        
        // ÂÖ®„Ç∑„Çπ„ÉÜ„É†„ÅÆÊ∂àË≤ªÈõªÂäõ„ÇíÊõ¥Êñ∞
        function updateTotalSystemPower() {
            const total = racks.reduce((sum, rack) => {
                return sum + rack.equipment.reduce((rackSum, eq) => rackSum + (eq.power || 0), 0);
            }, 0);
            
            document.getElementById('totalSystemPower').textContent = `${total} W`;
        }
        
        // „É©„ÉÉ„ÇØ„ÅÆÊ∂àË≤ªÈõªÂäõ„ÇíÊõ¥Êñ∞ÔºàIDÊé•È†≠ËæûÂØæÂøúÔºâ
        function updateRackPower(rackIndex, isMini) {
            const rack = racks[rackIndex];
            const total = rack.equipment.reduce((sum, eq) => sum + (eq.power || 0), 0);
            
            const prefix = isMini ? 'mini' : 'single';
            const powerTotalElement = document.getElementById(`${prefix}-powerTotal-${rackIndex}`);
            if (powerTotalElement) {
                powerTotalElement.textContent = `ÂêàË®à: ${total} W`;
            }
            
            updateTotalSystemPower();
        }
        
        // Ê©üÂô®„ÅÆÈõªÂäõ„ÇíÊõ¥Êñ∞
        function updatePower(equipmentId, rackIndex, value) {
            const rack = racks[rackIndex];
            const equipment = rack.equipment.find(eq => eq.id === equipmentId);
            if (equipment) {
                equipment.power = parseFloat(value) || 0;
                updateRackPower(rackIndex, viewMode === 'all');
                updateEquipmentList();
            }
        }
        
        // Ê©üÂô®„ÇíÂâäÈô§
        function deleteEquipment(equipmentId, rackIndex) {
            const rack = racks[rackIndex];
            rack.equipment = rack.equipment.filter(eq => eq.id !== equipmentId);
            
            if (viewMode === 'single' && rackIndex === currentRackIndex) {
                renderSingleRack();
            } else if (viewMode === 'all') {
                renderAllRacks();
            }
            
            updateEquipmentList();
            updateTotalSystemPower();
        }
        
        // ÁèæÂú®„ÅÆ„É©„ÉÉ„ÇØ„Çí„ÇØ„É™„Ç¢
        function clearCurrentRack() {
            if (confirm('ÁèæÂú®„ÅÆ„É©„ÉÉ„ÇØ„ÅÆ„Åô„Åπ„Å¶„ÅÆÊ©üÂô®„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                racks[currentRackIndex].equipment = [];
                
                if (viewMode === 'single') {
                    renderSingleRack();
                } else {
                    renderAllRacks();
                }
                
                updateEquipmentList();
                updateTotalSystemPower();
            }
        }
        
        // Ê©üÂô®„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateEquipmentList() {
            const listContent = document.getElementById('equipmentListContent');
            const rack = racks[currentRackIndex];
            
            if (rack.equipment.length === 0) {
                listContent.innerHTML = '<div style="color: #999; font-size: 12px;">Ê©üÂô®„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            listContent.innerHTML = rack.equipment
                .sort((a, b) => b.startUnit - a.startUnit)
                .map(eq => `
                    <div class="equipment-list-item">
                        <span>${eq.name} (${eq.startUnit}U-${eq.startUnit + eq.size - 1}U)</span>
                        <span class="equipment-list-power">${eq.power || 0}W</span>
                    </div>
                `).join('');
        }
        
        // „É¶„Éã„ÉÉ„Éà„ÅÆÊ©üÂô®„ÇíÂèñÂæó
        function getEquipmentAtUnit(rack, unit) {
            return rack.equipment.find(eq => unit >= eq.startUnit && unit < eq.startUnit + eq.size);
        }
        
        // „Éá„Éï„Ç©„É´„ÉàÂêç„ÇíÂèñÂæó
        function getDefaultName(type) {
            const customType = settings.customTypes.find(t => t.id === type);
            if (customType) return customType.name;
            
            const names = {
                nas: 'NAS',
                sv: 'Server',
                ups: 'UPS',
                switch: 'Switch',
                lcd: 'LCD Console',
                router: 'Router'
            };
            return names[type] || 'Equipment';
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
        function handleDragStart(e) {
            const equipmentId = parseInt(e.target.dataset.id);
            const rackIndex = parseInt(e.target.dataset.rackIndex);
            const rack = racks[rackIndex];
            
            draggedEquipment = rack.equipment.find(eq => eq.id === equipmentId);
            draggedFromRack = rackIndex;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.unit-space').forEach(unit => {
                unit.classList.remove('drag-over');
            });
            draggedEquipment = null;
            draggedFromRack = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const unit = parseInt(e.target.dataset.unit);
            const rackIndex = parseInt(e.target.dataset.rackIndex);
            const rack = racks[rackIndex];
            
            if (!draggedEquipment) return;
            
            let canPlace = true;
            for (let i = unit; i < unit + draggedEquipment.size; i++) {
                if (i > rack.height) {
                    canPlace = false;
                    break;
                }
                const existing = getEquipmentAtUnit(rack, i);
                if (existing && (draggedFromRack !== rackIndex || existing.id !== draggedEquipment.id)) {
                    canPlace = false;
                    break;
                }
            }
            
            if (canPlace) {
                e.target.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (!draggedEquipment) return;
            
            const newStartUnit = parseInt(e.target.dataset.unit);
            const targetRackIndex = parseInt(e.target.dataset.rackIndex);
            const targetRack = racks[targetRackIndex];
            
            let canPlace = true;
            for (let i = newStartUnit; i < newStartUnit + draggedEquipment.size; i++) {
                if (i > targetRack.height) {
                    canPlace = false;
                    break;
                }
                const existing = getEquipmentAtUnit(targetRack, i);
                if (existing && (draggedFromRack !== targetRackIndex || existing.id !== draggedEquipment.id)) {
                    canPlace = false;
                    break;
                }
            }
            
            if (canPlace) {
                // ÂÖÉ„ÅÆ„É©„ÉÉ„ÇØ„Åã„ÇâÂâäÈô§
                if (draggedFromRack !== targetRackIndex) {
                    racks[draggedFromRack].equipment = racks[draggedFromRack].equipment.filter(
                        eq => eq.id !== draggedEquipment.id
                    );
                    // Êñ∞„Åó„ÅÑ„É©„ÉÉ„ÇØ„Å´ËøΩÂä†
                    draggedEquipment.startUnit = newStartUnit;
                    targetRack.equipment.push(draggedEquipment);
                } else {
                    // Âêå„Åò„É©„ÉÉ„ÇØÂÜÖ„Åß„ÅÆÁßªÂãï
                    const equipment = targetRack.equipment.find(eq => eq.id === draggedEquipment.id);
                    if (equipment) {
                        equipment.startUnit = newStartUnit;
                    }
                }
                
                if (viewMode === 'single') {
                    renderSingleRack();
                } else {
                    renderAllRacks();
                }
                updateEquipmentList();
                updateTotalSystemPower();
            }
            
            draggedEquipment = null;
            draggedFromRack = null;
        }
        
        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openEditModal(equipmentId, rackIndex) {
            const rack = racks[rackIndex];
            const equipment = rack.equipment.find(eq => eq.id === equipmentId);
            if (!equipment) return;
            
            editingEquipmentId = equipmentId;
            editingRackIndex = rackIndex;
            
            document.getElementById('editName').value = equipment.name;
            document.getElementById('editPower').value = equipment.power || 0;
            
            if (equipment.size <= 4) {
                document.getElementById('editSize').value = equipment.size;
                document.getElementById('editCustomSizeInput').classList.remove('show');
            } else {
                document.getElementById('editSize').value = 'custom';
                document.getElementById('editCustomSize').value = equipment.size;
                document.getElementById('editCustomSizeInput').classList.add('show');
            }
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        // Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingEquipmentId = null;
            editingRackIndex = null;
        }
        
        // Á∑®ÈõÜ„Çí‰øùÂ≠ò
        function saveEdit() {
            if (!editingEquipmentId || editingRackIndex === null) return;
            
            const rack = racks[editingRackIndex];
            const equipment = rack.equipment.find(eq => eq.id === editingEquipmentId);
            if (!equipment) return;
            
            let newSize = document.getElementById('editSize').value;
            if (newSize === 'custom') {
                newSize = parseInt(document.getElementById('editCustomSize').value);
                if (!newSize || newSize < 1) {
                    alert('„Ç´„Çπ„Çø„É†„Çµ„Ç§„Ç∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
            } else {
                newSize = parseInt(newSize);
            }
            
            if (newSize !== equipment.size) {
                for (let i = equipment.startUnit; i < equipment.startUnit + newSize; i++) {
                    if (i > rack.height) {
                        alert('Ê©üÂô®„Åå„É©„ÉÉ„ÇØ„ÅÆÁØÑÂõ≤„ÇíË∂Ö„Åà„Åæ„Åô');
                        return;
                    }
                    const existing = getEquipmentAtUnit(rack, i);
                    if (existing && existing.id !== equipment.id) {
                        alert('ÊåáÂÆö„Åó„Åü„Çµ„Ç§„Ç∫„Åß„ÅØ‰ªñ„ÅÆÊ©üÂô®„Å®ÈáçË§á„Åó„Åæ„Åô');
                        return;
                    }
                }
            }
            
            equipment.name = document.getElementById('editName').value || equipment.name;
            equipment.size = newSize;
            equipment.power = parseFloat(document.getElementById('editPower').value) || 0;
            
            closeEditModal();
            
            if (viewMode === 'single') {
                renderSingleRack();
            } else {
                renderAllRacks();
            }
            updateEquipmentList();
            updateTotalSystemPower();
        }
        
        // „Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            const data = {
                version: '2.0',
                racks: racks,
                settings: settings,
                memories: savedMemories
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rack_diagram_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // „Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.version === '1.0') {
                        // Êóß„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Éá„Éº„Çø„ÇíÂ§âÊèõ
                        racks = [{
                            id: Date.now(),
                            name: '„Ç§„É≥„Éù„Éº„Éà„É©„ÉÉ„ÇØ',
                            height: data.rackHeight,
                            equipment: data.equipment || []
                        }];
                        settings = data.settings || settings;
                    } else if (data.version === '2.0') {
                        racks = data.racks || [];
                        settings = data.settings || settings;
                        savedMemories = data.memories || [];
                    } else {
                        alert('ÈùûÂØæÂøú„ÅÆ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                        return;
                    }
                    
                    currentRackIndex = 0;
                    saveSettings();
                    saveMemoriesToStorage();
                    updateRackTabs();
                    switchToRack(0);
                    updateMemoryList();
                    alert('„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                } catch (error) {
                    alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Ë®≠ÂÆöÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function updateEquipmentTypeSelect() {
            const select = document.getElementById('equipmentType');
            
            Array.from(select.options).forEach(option => {
                if (option.dataset.custom === 'true') {
                    option.remove();
                }
            });
            
            settings.customTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                option.dataset.custom = 'true';
                select.appendChild(option);
            });
        }
        
        function openSettingsModal() {
            document.getElementById('colorCoding').checked = settings.colorCoding;
            updateCustomTypesList();
            updateDefaultTypeColors();
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function updateCustomTypesList() {
            const list = document.getElementById('customTypesList');
            list.innerHTML = settings.customTypes.map(type => `
                <div class="custom-type-item">
                    <span>${type.name}</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div class="custom-type-color" style="background: ${type.color}"></div>
                        <button class="remove-type-btn" onclick="removeCustomType('${type.id}')">ÂâäÈô§</button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateDefaultTypeColors() {
            const container = document.getElementById('defaultTypeColors');
            const types = {
                nas: 'NAS',
                sv: '„Çµ„Éº„Éê„Éº',
                ups: 'UPS',
                switch: '„Çπ„Ç§„ÉÉ„ÉÅ',
                lcd: 'LCD„Ç≥„É≥„ÇΩ„Éº„É´',
                router: '„É´„Éº„Çø„Éº'
            };
            
            container.innerHTML = Object.entries(types).map(([key, name]) => `
                <div class="color-picker-group">
                    <label style="width: 100px;">${name}</label>
                    <input type="color" id="color-${key}" value="${settings.typeColors[key]}" 
                           onchange="updateTypeColor('${key}', this.value)">
                </div>
            `).join('');
        }
        
        function updateTypeColor(type, color) {
            settings.typeColors[type] = color;
        }
        
        function addCustomType() {
            const name = document.getElementById('newTypeName').value;
            const color = document.getElementById('newTypeColor').value;
            
            if (!name) {
                alert('Ê©üÂô®„Çø„Ç§„ÉóÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const customType = {
                id: 'custom_' + Date.now(),
                name: name,
                color: color
            };
            
            settings.customTypes.push(customType);
            settings.typeColors[customType.id] = color;
            
            document.getElementById('newTypeName').value = '';
            updateCustomTypesList();
            updateEquipmentTypeSelect();
        }
        
        function removeCustomType(id) {
            settings.customTypes = settings.customTypes.filter(type => type.id !== id);
            delete settings.typeColors[id];
            updateCustomTypesList();
            updateEquipmentTypeSelect();
        }
        
        function saveSettings() {
            settings.colorCoding = document.getElementById('colorCoding').checked;
            localStorage.setItem('rackSettings', JSON.stringify(settings));
            
            if (viewMode === 'single') {
                renderSingleRack();
            } else {
                renderAllRacks();
            }
            
            closeSettingsModal();
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('rackSettings');
            if (saved) {
                settings = JSON.parse(saved);
            }
            updateEquipmentTypeSelect();
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('equipmentSize').addEventListener('change', (e) => {
            const customInput = document.getElementById('customSizeInput');
            if (e.target.value === 'custom') {
                customInput.classList.add('show');
            } else {
                customInput.classList.remove('show');
            }
        });
        
        document.getElementById('editSize').addEventListener('change', (e) => {
            const customInput = document.getElementById('editCustomSizeInput');
            if (e.target.value === 'custom') {
                customInput.classList.add('show');
            } else {
                customInput.classList.remove('show');
            }
        });
        
        document.getElementById('rackHeight').addEventListener('change', (e) => {
            const customInput = document.getElementById('customRackHeightInput');
            if (e.target.value === 'custom') {
                customInput.classList.add('show');
            } else {
                customInput.classList.remove('show');
                const newHeight = parseInt(e.target.value);
                const rack = racks[currentRackIndex];
                
                if (rack.equipment.length > 0 && !confirm('„É©„ÉÉ„ÇØÈ´ò„Åï„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅÁèæÂú®„ÅÆÊ©üÂô®ÈÖçÁΩÆ„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                    if (rack.height <= 48 && [12, 24, 36, 42, 48].includes(rack.height)) {
                        e.target.value = rack.height;
                    } else {
                        e.target.value = 'custom';
                        customInput.classList.add('show');
                    }
                    return;
                }
                
                rack.height = newHeight;
                rack.equipment = [];
                
                if (viewMode === 'single') {
                    renderSingleRack();
                } else {
                    renderAllRacks();
                }
                updateEquipmentList();
                updateTotalSystemPower();
            }
        });
        
        document.getElementById('customRackHeight').addEventListener('change', () => {
            const rack = racks[currentRackIndex];
            const newHeight = parseInt(document.getElementById('customRackHeight').value);
            
            if (!newHeight || newHeight < 1) return;
            
            if (rack.equipment.length > 0 && !confirm('„É©„ÉÉ„ÇØÈ´ò„Åï„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅÁèæÂú®„ÅÆÊ©üÂô®ÈÖçÁΩÆ„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                document.getElementById('customRackHeight').value = rack.height;
                return;
            }
            
            rack.height = newHeight;
            rack.equipment = [];
            
            if (viewMode === 'single') {
                renderSingleRack();
            } else {
                renderAllRacks();
            }
            updateEquipmentList();
            updateTotalSystemPower();
        });
        
        document.getElementById('equipmentType').addEventListener('change', (e) => {
            const sizeSelect = document.getElementById('equipmentSize');
            if (e.target.value === 'lcd' || e.target.value === 'router') {
                sizeSelect.value = '1';
                sizeSelect.disabled = true;
                document.getElementById('customSizeInput').classList.remove('show');
            } else {
                sizeSelect.disabled = false;
            }
        });
        
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
                editingEquipmentId = null;
                editingRackIndex = null;
            }
        }
        
        // ÂàùÊúüÂåñÂÆüË°å
        init();
    </script>
</body>
</html>
